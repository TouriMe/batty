!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof module&&module.exports?module.exports=function(i,t){return void 0===t&&(t="undefined"!=typeof window?require("jquery"):require("jquery")(i)),e(t),t}:e(jQuery)}(function(e){"use strict";e.extend(e.FE.POPUP_TEMPLATES,{"file.insert":"[_BUTTONS_][_UPLOAD_LAYER_][_PROGRESS_BAR_]"}),e.extend(e.FE.DEFAULTS,{fileUploadURL:"http://i.froala.com/upload",fileUploadParam:"file",fileUploadParams:{},fileUploadToS3:!1,fileUploadMethod:"POST",fileMaxSize:10485760,fileAllowedTypes:["*"],fileInsertButtons:["fileBack","|"],fileUseSelectedText:!1}),e.FE.PLUGINS.file=function(i){function t(){var e=i.$tb.find('.fr-command[data-cmd="insertFile"]'),t=i.popups.get("file.insert");if(t||(t=y()),n(),!t.hasClass("fr-active")){i.popups.refresh("file.insert"),i.popups.setContainer("file.insert",i.$tb);var r=e.offset().left+e.outerWidth()/2,o=e.offset().top+(i.opts.toolbarBottom?0:e.outerHeight());i.popups.show("file.insert",r,o,e.outerHeight())}}function r(){var e=i.popups.get("file.insert");e||(e=y()),e.find(".fr-layer.fr-active").removeClass("fr-active").addClass("fr-pactive"),e.find(".fr-file-progress-bar-layer").addClass("fr-active"),e.find(".fr-buttons").hide(),o("Uploading",0)}function n(e){var t=i.popups.get("file.insert");t&&(t.find(".fr-layer.fr-pactive").addClass("fr-active").removeClass("fr-pactive"),t.find(".fr-file-progress-bar-layer").removeClass("fr-active"),t.find(".fr-buttons").show(),e&&i.popups.show("file.insert",null,null))}function o(e,t){var r=i.popups.get("file.insert");if(r){var n=r.find(".fr-file-progress-bar-layer");n.find("h3").text(e+(t?" "+t+"%":"")),n.removeClass("fr-error"),t?(n.find("div").removeClass("fr-indeterminate"),n.find("div > span").css("width",t+"%")):n.find("div").addClass("fr-indeterminate")}}function s(e){r();var t=i.popups.get("file.insert"),n=t.find(".fr-file-progress-bar-layer");n.addClass("fr-error"),n.find("h3").text(e)}function a(e,t,r){i.edit.on(),i.events.focus(!0),i.selection.restore(),i.html.insert('<a href="'+e+'" id="fr-inserted-file" class="fr-file">'+(t||i.selection.text())+"</a>");var n=i.$el.find("#fr-inserted-file");n.removeAttr("id"),i.popups.hide("file.insert"),i.undo.saveStep(),i.events.trigger("file.inserted",[n,r])}function l(t){try{if(i.events.trigger("file.uploaded",[t],!0)===!1)return i.edit.on(),!1;var r=e.parseJSON(t);return r.link?r:(c(k,t),!1)}catch(n){return c(P,t),!1}}function f(t){try{var r=e(t).find("Location").text(),n=e(t).find("Key").text();return i.events.trigger("file.uploadedToS3",[r,n,t],!0)===!1?(i.edit.on(),!1):r}catch(o){return c(P,t),!1}}function p(e){var t=this.status,r=this.response,n=this.responseXML,o=this.responseText;try{if(i.opts.fileUploadToS3)if(201==t){var s=f(n);s&&a(s,e,r||n)}else c(P,r||n);else if(t>=200&&300>t){var p=l(o);p&&a(p.link,e,r||o)}else c(w,r||o)}catch(d){c(P,r||o)}}function d(){c(P,this.response||this.responseText||this.responseXML)}function u(e){if(e.lengthComputable){var i=e.loaded/e.total*100|0;o("Uploading",i)}}function c(e,t){i.edit.on(),s(i.language.translate("Something went wrong. Please try again.")),i.events.trigger("file.error",[{code:e,message:O[e]},t])}function v(){i.edit.on(),n(!0)}function g(e){if(i.events.trigger("file.beforeUpload",[e])===!1)return!1;if("undefined"!=typeof e&&e.length>0){var t=e[0];if(t.size>i.opts.fileMaxSize)return c(x),!1;if(i.opts.fileAllowedTypes.indexOf("*")<0&&i.opts.fileAllowedTypes.indexOf(t.type.replace(/file\//g,""))<0)return c(F),!1;var n;if(i.drag_support.formdata&&(n=i.drag_support.formdata?new FormData:null),n){var o;if(i.opts.fileUploadToS3!==!1){n.append("key",i.opts.fileUploadToS3.keyStart+(new Date).getTime()+"-"+(t.name||"untitled")),n.append("success_action_status","201"),n.append("X-Requested-With","xhr"),n.append("Content-Type",t.type);for(o in i.opts.fileUploadToS3.params)i.opts.fileUploadToS3.params.hasOwnProperty(o)&&n.append(o,i.opts.fileUploadToS3.params[o])}for(o in i.opts.fileUploadParams)i.opts.fileUploadParams.hasOwnProperty(o)&&n.append(o,i.opts.fileUploadParams[o]);n.append(i.opts.fileUploadParam,t);var s=i.opts.fileUploadURL;i.opts.fileUploadToS3&&(s="https://"+i.opts.fileUploadToS3.region+".amazonaws.com/"+i.opts.fileUploadToS3.bucket);var a=i.core.getXHR(s,i.opts.fileUploadMethod);a.onload=function(){p.call(a,[i.opts.fileUseSelectedText?null:t.name])},a.onerror=d,a.upload.onprogress=u,a.onabort=v,r(),i.edit.off();var l=i.popups.get("file.insert");l&&l.off("abortUpload").on("abortUpload",function(){4!=a.readyState&&a.abort()}),a.send(n)}}}function h(t){i.events.$on(t,"dragover dragenter",".fr-file-upload-layer",function(){return e(this).addClass("fr-drop"),!1},!0),i.events.$on(t,"dragleave dragend",".fr-file-upload-layer",function(){return e(this).removeClass("fr-drop"),!1},!0),i.events.$on(t,"drop",".fr-file-upload-layer",function(r){r.preventDefault(),r.stopPropagation(),e(this).removeClass("fr-drop");var n=r.originalEvent.dataTransfer;if(n&&n.files){var o=t.data("instance")||i;o.file.upload(n.files)}},!0),i.events.$on(t,"change",'.fr-file-upload-layer input[type="file"]',function(){if(this.files){var r=t.data("instance")||i;r.file.upload(this.files)}e(this).val("")},!0)}function m(){n()}function y(e){if(e)return i.popups.onHide("file.insert",m),!0;var t="";t='<div class="fr-buttons">'+i.button.buildList(i.opts.fileInsertButtons)+"</div>";var r="";r='<div class="fr-file-upload-layer fr-layer fr-active" id="fr-file-upload-layer-'+i.id+'"><strong>'+i.language.translate("Drop file")+"</strong><br>("+i.language.translate("or click")+')<div class="fr-form"><input type="file" name="'+i.opts.fileUploadParam+'" accept="/*" tabIndex="-1"></div></div>';var n='<div class="fr-file-progress-bar-layer fr-layer"><h3 class="fr-message">Uploading</h3><div class="fr-loader"><span class="fr-progress"></span></div><div class="fr-action-buttons"><button type="button" class="fr-command" data-cmd="fileDismissError" tabIndex="2">OK</button></div></div>',o={buttons:t,upload_layer:r,progress_bar:n},s=i.popups.create("file.insert",o);return h(s),s}function b(t){return e(t).hasClass("fr-file")?i.events.trigger("file.unlink",[t]):void 0}function U(t){var n=t.originalEvent.dataTransfer;if(n&&n.files&&n.files.length){var o=n.files[0];if(o&&"undefined"!=typeof o.type&&o.type.indexOf("image")<0&&(i.opts.fileAllowedTypes.indexOf(o.type)>=0||i.opts.fileAllowedTypes.indexOf("*")>=0)){i.markers.remove(),i.markers.insertAtPoint(t.originalEvent),i.$el.find(".fr-marker").replaceWith(e.FE.MARKERS),i.popups.hideAll();var s=i.popups.get("file.insert");return s||(s=y()),i.popups.setContainer("file.insert",e(i.opts.scrollableContainer)),i.popups.show("file.insert",t.originalEvent.pageX,t.originalEvent.pageY),r(),g(n.files),t.preventDefault(),t.stopPropagation(),!1}}}function C(){i.events.on("drop",U),i.events.$on(i.$win,"keydown",function(t){var r=t.which,n=i.popups.get("file.insert");n&&r==e.FE.KEYCODE.ESC&&n.trigger("abortUpload")}),i.events.on("destroy",function(){var e=i.popups.get("file.insert");e&&e.trigger("abortUpload")})}function E(){i.events.disableBlur(),i.selection.restore(),i.events.enableBlur(),i.popups.hide("file.insert"),i.toolbar.showInline()}function T(){C(),i.events.on("link.beforeRemove",b),y(!0)}var S=1,k=2,w=3,P=4,x=5,F=6,A=7,O={};return O[S]="File cannot be loaded from the passed link.",O[k]="No link in upload response.",O[w]="Error during file upload.",O[P]="Parsing response failed.",O[x]="File is too large.",O[F]="File file type is invalid.",O[A]="Files can be uploaded only to same domain in IE 8 and IE 9.",{_init:T,showInsertPopup:t,upload:g,insert:a,back:E,hideProgressBar:n}},e.FE.DefineIcon("insertFile",{NAME:"file-o"}),e.FE.RegisterCommand("insertFile",{title:"Upload File",undo:!1,focus:!0,refreshAfterCallback:!1,popup:!0,callback:function(){this.popups.isVisible("file.insert")?(this.$el.find(".fr-marker")&&(this.events.disableBlur(),this.selection.restore()),this.popups.hide("file.insert")):this.file.showInsertPopup()},plugin:"file"}),e.FE.DefineIcon("fileBack",{NAME:"arrow-left"}),e.FE.RegisterCommand("fileBack",{title:"Back",undo:!1,focus:!1,back:!0,refreshAfterCallback:!1,callback:function(){this.file.back()},refresh:function(e){this.opts.toolbarInline?(e.removeClass("fr-hidden"),e.next(".fr-separator").removeClass("fr-hidden")):(e.addClass("fr-hidden"),e.next(".fr-separator").addClass("fr-hidden"))}}),e.FE.RegisterCommand("fileDismissError",{title:"OK",callback:function(){this.file.hideProgressBar(!0)}})});