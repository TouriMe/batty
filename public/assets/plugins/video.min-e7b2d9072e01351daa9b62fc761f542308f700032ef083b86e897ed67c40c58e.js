!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof module&&module.exports?module.exports=function(t,i){return void 0===i&&(i="undefined"!=typeof window?require("jquery"):require("jquery")(t)),e(i),i}:e(jQuery)}(function(e){"use strict";e.extend(e.FE.POPUP_TEMPLATES,{"video.insert":"[_BUTTONS_][_BY_URL_LAYER_][_EMBED_LAYER_]","video.edit":"[_BUTTONS_]","video.size":"[_BUTTONS_][_SIZE_LAYER_]"}),e.extend(e.FE.DEFAULTS,{videoInsertButtons:["videoBack","|","videoByURL","videoEmbed"],videoEditButtons:["videoDisplay","videoAlign","videoSize","videoRemove"],videoResize:!0,videoSizeButtons:["videoBack","|"],videoSplitHTML:!1,videoTextNear:!0,videoDefaultAlign:"center",videoDefaultDisplay:"block",videoMove:!0}),e.FE.VIDEO_PROVIDERS=[{test_regex:/^.*((youtu.be)|(youtube.com))\/((v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))?\??v?=?([^#\&\?]*).*/,url_regex:/(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/)?([0-9a-zA-Z_\-]+)(.+)?/g,url_text:"//www.youtube.com/embed/$1",html:'<iframe width="640" height="360" src="{url}?wmode=opaque" frameborder="0" allowfullscreen></iframe>'},{test_regex:/^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/,url_regex:/(?:https?:\/\/)?(?:www\.)?(?:vimeo\.com)\/(?:channels\/[A-z]+\/|groups\/[A-z]+\/videos\/)?(.+)/g,url_text:"//player.vimeo.com/video/$1",html:'<iframe width="640" height="360" src="{url}" frameborder="0" allowfullscreen></iframe>'},{test_regex:/^.+(dailymotion.com|dai.ly)\/(video|hub)?\/?([^_]+)[^#]*(#video=([^_&]+))?/,url_regex:/(?:https?:\/\/)?(?:www\.)?(?:dailymotion\.com|dai\.ly)\/(?:video|hub)?\/?(.+)/g,url_text:"//www.dailymotion.com/embed/video/$1",html:'<iframe width="640" height="360" src="{url}" frameborder="0" allowfullscreen></iframe>'},{test_regex:/^.+(screen.yahoo.com)\/[^_&]+/,url_regex:"",url_text:"",html:'<iframe width="640" height="360" src="{url}?format=embed" frameborder="0" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" allowtransparency="true"></iframe>'},{test_regex:/^.+(rutube.ru)\/[^_&]+/,url_regex:/(?:https?:\/\/)?(?:www\.)?(?:rutube\.ru)\/(?:video)?\/?(.+)/g,url_text:"//rutube.ru/play/embed/$1",html:'<iframe width="640" height="360" src="{url}" frameborder="0" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" allowtransparency="true"></iframe>'}],e.FE.VIDEO_EMBED_REGEX=/^\W*((<iframe.*><\/iframe>)|(<embed.*>))\W*$/i,e.FE.PLUGINS.video=function(t){function i(){var e=t.popups.get("video.insert"),i=e.find(".fr-video-by-url-layer input");i.val("").trigger("change");var o=e.find(".fr-video-embed-layer textarea");o.val("").trigger("change")}function o(){var e=t.$tb.find('.fr-command[data-cmd="insertVideo"]'),i=t.popups.get("video.insert");if(i||(i=s()),!i.hasClass("fr-active")){t.popups.refresh("video.insert"),t.popups.setContainer("video.insert",t.$tb);var o=e.offset().left+e.outerWidth()/2,r=e.offset().top+(t.opts.toolbarBottom?10:e.outerHeight()-10);t.popups.show("video.insert",o,r,e.outerHeight())}}function r(){var i=t.popups.get("video.edit");i||(i=x()),t.popups.setContainer("video.edit",e(t.opts.scrollableContainer)),t.popups.refresh("video.edit");var o=j.find("iframe, embed, video"),r=o.offset().left+o.outerWidth()/2,s=o.offset().top+o.outerHeight();t.popups.show("video.edit",r,s,o.outerHeight())}function s(e){if(e)return t.popups.onRefresh("video.insert",i),!0;var o="";t.opts.videoInsertButtons.length>1&&(o='<div class="fr-buttons">'+t.button.buildList(t.opts.videoInsertButtons)+"</div>");var r="";t.opts.videoInsertButtons.indexOf("videoByURL")>=0&&(r='<div class="fr-video-by-url-layer fr-layer fr-active" id="fr-video-by-url-layer-'+t.id+'"><div class="fr-input-line"><input type="text" placeholder="http://" tabIndex="1"></div><div class="fr-action-buttons"><button type="button" class="fr-command fr-submit" data-cmd="videoInsertByURL" tabIndex="2">'+t.language.translate("Insert")+"</button></div></div>");var s="";t.opts.videoInsertButtons.indexOf("videoEmbed")>=0&&(s='<div class="fr-video-embed-layer fr-layer" id="fr-video-embed-layer-'+t.id+'"><div class="fr-input-line"><textarea type="text" placeholder="'+t.language.translate("Embedded Code")+'" tabIndex="1" rows="5"></textarea></div><div class="fr-action-buttons"><button type="button" class="fr-command fr-submit" data-cmd="videoInsertEmbed" tabIndex="2">'+t.language.translate("Insert")+"</button></div></div>");var n={buttons:o,by_url_layer:r,embed_layer:s},a=t.popups.create("video.insert",n);return a}function n(e){var i,o,r=t.popups.get("video.insert");if(!j&&!t.opts.toolbarInline){var s=t.$tb.find('.fr-command[data-cmd="insertVideo"]');i=s.offset().left+s.outerWidth()/2,o=s.offset().top+(t.opts.toolbarBottom?10:s.outerHeight()-10)}t.opts.toolbarInline&&(o=r.offset().top-t.helpers.getPX(r.css("margin-top")),r.hasClass("fr-above")&&(o+=r.outerHeight())),r.find(".fr-layer").removeClass("fr-active"),r.find(".fr-"+e+"-layer").addClass("fr-active"),t.popups.show("video.insert",i,o,0)}function a(e){var i=t.popups.get("video.insert");i.find(".fr-video-by-url-layer").hasClass("fr-active")&&e.addClass("fr-active")}function d(e){var i=t.popups.get("video.insert");i.find(".fr-video-embed-layer").hasClass("fr-active")&&e.addClass("fr-active")}function l(e){t.events.focus(!0),t.selection.restore(),t.html.insert('<span contenteditable="false" draggable="true" class="fr-jiv fr-video fr-dv'+t.opts.videoDefaultDisplay[0]+("center"!=t.opts.videoDefaultAlign?" fr-fv"+t.opts.videoDefaultAlign[0]:"")+'">'+e+"</span>",!1,t.opts.videoSplitHTML),t.popups.hide("video.insert");var i=t.$el.find(".fr-jiv");i.removeClass("fr-jiv"),i.toggleClass("fr-draggable",t.opts.videoMove),t.events.trigger("video.inserted",[i])}function f(i){if("undefined"==typeof i){var o=t.popups.get("video.insert");i=o.find('.fr-video-by-url-layer input[type="text"]').val()||""}var r=null;if(t.helpers.isURL(i))for(var s=0;s<e.FE.VIDEO_PROVIDERS.length;s++){var n=e.FE.VIDEO_PROVIDERS[s];if(n.test_regex.test(i)){r=i.replace(n.url_regex,n.url_text),r=n.html.replace(/\{url\}/,r);break}}r?l(r):t.events.trigger("video.linkError",[i])}function v(i){if("undefined"==typeof i){var o=t.popups.get("video.insert");i=o.find(".fr-video-embed-layer textarea").val()||""}0!==i.length&&e.FE.VIDEO_EMBED_REGEX.test(i)?l(i):t.events.trigger("video.codeError",[i])}function u(i){if(!t.core.sameInstance(U))return!0;i.preventDefault(),i.stopPropagation();var o=i.pageX||(i.originalEvent.touches?i.originalEvent.touches[0].pageX:null),r=i.pageY||(i.originalEvent.touches?i.originalEvent.touches[0].pageY:null);return o&&r?(t.undo.canDo()||t.undo.saveStep(),V=e(this),V.data("start-x",o),V.data("start-y",r),T.show(),t.popups.hideAll(),void E()):!1}function c(e){if(!t.core.sameInstance(U))return!0;if(V){e.preventDefault();var i=e.pageX||(e.originalEvent.touches?e.originalEvent.touches[0].pageX:null),o=e.pageY||(e.originalEvent.touches?e.originalEvent.touches[0].pageY:null);if(!i||!o)return!1;var r=V.data("start-x"),s=V.data("start-y");V.data("start-x",i),V.data("start-y",o);var n=i-r,a=o-s,d=j.find("iframe, embed, video"),l=d.width(),f=d.height();(V.hasClass("fr-hnw")||V.hasClass("fr-hsw"))&&(n=0-n),(V.hasClass("fr-hnw")||V.hasClass("fr-hne"))&&(a=0-a),d.css("width",l+n),d.css("height",f+a),d.removeAttr("width"),d.removeAttr("height"),g()}}function p(e){return t.core.sameInstance(U)?void(V&&j&&(e&&e.stopPropagation(),V=null,T.hide(),g(),r(),t.undo.saveStep())):!0}function h(e){return'<div class="fr-handler fr-h'+e+'"></div>'}function m(){var i;t.shared.$video_resizer?(U=t.shared.$video_resizer,T=t.shared.$vid_overlay,t.events.on("destroy",function(){U.removeClass("fr-active").appendTo(e("body"))},!0)):(t.shared.$video_resizer=e('<div class="fr-video-resizer"></div>'),U=t.shared.$video_resizer,t.events.$on(U,"mousedown",function(e){e.stopPropagation()},!0),t.opts.videoResize&&(U.append(h("nw")+h("ne")+h("sw")+h("se")),t.shared.$vid_overlay=e('<div class="fr-video-overlay"></div>'),T=t.shared.$vid_overlay,i=U.get(0).ownerDocument,e(i).find("body").append(T))),t.events.on("shared.destroy",function(){U.html("").removeData().remove(),U=null,t.opts.videoResize&&(T.remove(),T=null)},!0),t.helpers.isMobile()||t.events.$on(e(t.o_win),"resize.video",function(){w(!0)}),t.opts.videoResize&&(i=U.get(0).ownerDocument,t.events.$on(U,t._mousedown,".fr-handler",u),t.events.$on(e(i),t._mousemove,c),t.events.$on(e(i.defaultView||i.parentWindow),t._mouseup,p),t.events.$on(T,"mouseleave",p))}function g(){U||m(),(t.$wp||e(t.opts.scrollableContainer)).append(U),U.data("instance",t);var i=j.find("iframe, embed, video");U.css("top",(t.opts.iframe?i.offset().top-1:i.offset().top-t.$wp.offset().top-1)+t.$wp.scrollTop()).css("left",(t.opts.iframe?i.offset().left-1:i.offset().left-t.$wp.offset().left-1)+t.$wp.scrollLeft()).css("width",i.outerWidth()).css("height",i.height()).addClass("fr-active")}function b(i){if(i&&"touchend"==i.type&&W)return!0;if(i.preventDefault(),i.stopPropagation(),t.edit.isDisabled())return!1;for(var o=0;o<e.FE.INSTANCES.length;o++)e.FE.INSTANCES[o]!=t&&e.FE.INSTANCES[o].events.trigger("video.hideResizer");t.toolbar.disable(),t.helpers.isMobile()&&(t.events.disableBlur(),t.$el.blur(),t.events.enableBlur()),j=e(this),e(this).addClass("fr-active"),t.opts.iframe&&t.size.syncIframe(),g(),r(),t.selection.clear(),t.button.bulkRefresh(),t.events.trigger("image.hideResizer")}function w(e){j&&(C()||e===!0)&&(U.removeClass("fr-active"),t.toolbar.enable(),j.removeClass("fr-active"),j=null,E())}function y(){t.shared.vid_exit_flag=!0}function E(){t.shared.vid_exit_flag=!1}function C(){return t.shared.vid_exit_flag}function _(){t.events.on("mousedown window.mousedown",y),t.events.on("window.touchmove",E),t.events.on("mouseup window.mouseup",w),t.events.on("commands.mousedown",function(e){e.parents(".fr-toolbar").length>0&&w()}),t.events.on("blur video.hideResizer commands.undo commands.redo element.dropped",function(){w(!0)})}function x(){var e="";t.opts.videoEditButtons.length>=1&&(e+='<div class="fr-buttons">',e+=t.button.buildList(t.opts.videoEditButtons),e+="</div>");var i={buttons:e},o=t.popups.create("video.edit",i);return t.events.$on(t.$wp,"scroll.video-edit",function(){j&&t.popups.isVisible("video.edit")&&r()}),o}function I(){if(j){var e=t.popups.get("video.size"),i=j.find("iframe, embed, video");e.find('input[name="width"]').val(i.get(0).style.width||i.attr("width")).trigger("change"),e.find('input[name="height"]').val(i.get(0).style.height||i.attr("height")).trigger("change")}}function R(){var i=t.popups.get("video.size");i||(i=D()),t.popups.refresh("video.size"),t.popups.setContainer("video.size",e(t.opts.scrollableContainer));var o=j.find("iframe, embed, video"),r=o.offset().left+o.width()/2,s=o.offset().top+o.height();t.popups.show("video.size",r,s,o.height())}function D(e){if(e)return t.popups.onRefresh("video.size",I),!0;var i="";i='<div class="fr-buttons">'+t.button.buildList(t.opts.videoSizeButtons)+"</div>";var o="";o='<div class="fr-video-size-layer fr-layer fr-active" id="fr-video-size-layer-'+t.id+'"><div class="fr-video-group"><div class="fr-input-line"><input type="text" name="width" placeholder="'+t.language.translate("Width")+'" tabIndex="1"></div><div class="fr-input-line"><input type="text" name="height" placeholder="'+t.language.translate("Height")+'" tabIndex="1"></div></div><div class="fr-action-buttons"><button type="button" class="fr-command fr-submit" data-cmd="videoSetSize" tabIndex="2">'+t.language.translate("Update")+"</button></div></div>";var r={buttons:i,size_layer:o},s=t.popups.create("video.size",r);return t.events.$on(t.$wp,"scroll",function(){j&&t.popups.isVisible("video.size")&&R()}),s}function A(e){j.removeClass("fr-fvr fr-fvl"),"left"==e?j.addClass("fr-fvl"):"right"==e&&j.addClass("fr-fvr"),g(),r()}function B(e){return j?void(j.hasClass("fr-fvl")?e.find("> *:first").replaceWith(t.icon.create("align-left")):j.hasClass("fr-fvr")?e.find("> *:first").replaceWith(t.icon.create("align-right")):e.find("> *:first").replaceWith(t.icon.create("align-justify"))):!1}function z(e,t){var i="justify";j.hasClass("fr-fvl")?i="left":j.hasClass("fr-fvr")&&(i="right"),t.find('.fr-command[data-param1="'+i+'"]').addClass("fr-active")}function S(e){j.removeClass("fr-dvi fr-dvb"),"inline"==e?j.addClass("fr-dvi"):"block"==e&&j.addClass("fr-dvb"),g(),r()}function $(e,t){var i="block";j.hasClass("fr-dvi")&&(i="inline"),t.find('.fr-command[data-param1="'+i+'"]').addClass("fr-active")}function k(){if(j&&t.events.trigger("video.beforeRemove",[j])!==!1){var e=j;t.popups.hideAll(),w(!0),t.selection.setBefore(e.get(0))||t.selection.setAfter(e.get(0)),e.remove(),t.selection.restore(),t.html.fillEmptyBlocks(),t.events.trigger("video.removed",[e])}}function F(e){if(!e.hasClass("fr-dvi")&&!e.hasClass("fr-dvb")){var i=e.css("float");e.css("float","none"),"block"==e.css("display")?(e.css("float",i),0===parseInt(e.css("margin-left"),10)&&(e.attr("style")||"").indexOf("margin-right: auto")>=0?e.addClass("fr-fvl"):0===parseInt(e.css("margin-right"),10)&&(e.attr("style")||"").indexOf("margin-left: auto")>=0&&e.addClass("fr-fvr"),e.addClass("fr-dvb")):(e.css("float",i),"left"==e.css("float")?e.addClass("fr-fvl"):"right"==e.css("float")&&e.addClass("fr-fvr"),e.addClass("fr-dvi")),e.css("margin",""),e.css("float",""),e.css("display",""),e.css("z-index",""),e.css("position",""),e.css("overflow",""),e.css("vertical-align","")}t.opts.videoTextNear||e.removeClass("fr-dvi").addClass("fr-dvb")}function O(){t.$el.find("video").filter(function(){return 0===e(this).parents("span.fr-video").length}).wrap('<span class="fr-video" contenteditable="false"></span>'),t.$el.find("embed, iframe").filter(function(){if(t.browser.safari&&this.getAttribute("src")&&this.setAttribute("src",this.src),e(this).parents("span.fr-video").length>0)return!1;for(var i=e(this).attr("src"),o=0;o<e.FE.VIDEO_PROVIDERS.length;o++){var r=e.FE.VIDEO_PROVIDERS[o];if(r.test_regex.test(i))return!0}return!1}).map(function(){return 0===e(this).parents("object").length?this:e(this).parents("object").get(0)}).wrap('<span class="fr-video" contenteditable="false"></span>');for(var i=t.$el.find("span.fr-video"),o=0;o<i.length;o++)F(e(i[o]));i.toggleClass("fr-draggable",t.opts.videoMove)}function L(){_(),t.helpers.isMobile()&&(t.events.$on(t.$el,"touchstart","span.fr-video",function(){W=!1}),t.events.$on(t.$el,"touchmove",function(){W=!0})),t.events.on("html.set",O),O(),t.events.$on(t.$el,"mousedown","span.fr-video",function(e){e.stopPropagation()}),t.events.$on(t.$el,"click touchend","span.fr-video",b),t.events.on("keydown",function(i){var o=i.which;return!j||o!=e.FE.KEYCODE.BACKSPACE&&o!=e.FE.KEYCODE.DELETE?j&&o==e.FE.KEYCODE.ESC?(w(!0),i.preventDefault(),!1):j&&!t.keys.ctrlKey(i)?(i.preventDefault(),!1):void 0:(i.preventDefault(),k(),!1)},!0),t.events.on("keydown",function(){t.$el.find("span.fr-video:empty").remove()}),s(!0),D(!0)}function N(){j?j.trigger("click"):(t.events.disableBlur(),t.selection.restore(),t.events.enableBlur(),t.popups.hide("video.insert"),t.toolbar.showInline())}function M(e,i){if(j){var o=t.popups.get("video.size"),r=j.find("iframe, embed, video");r.css("width",e||o.find('input[name="width"]').val()),r.css("height",i||o.find('input[name="height"]').val()),r.get(0).style.width&&r.removeAttr("width"),r.get(0).style.height&&r.removeAttr("height"),o.find("input").blur(),setTimeout(function(){j.trigger("click")},t.helpers.isAndroid()?50:0)}}function P(){return j}var T,V,U,j,W;return t.shared.vid_exit_flag=!1,{_init:L,showInsertPopup:o,showLayer:n,refreshByURLButton:a,refreshEmbedButton:d,insertByURL:f,insertEmbed:v,insert:l,align:A,refreshAlign:B,refreshAlignOnShow:z,display:S,refreshDisplayOnShow:$,remove:k,showSizePopup:R,back:N,setSize:M,get:P}},e.FE.RegisterCommand("insertVideo",{title:"Insert Video",undo:!1,focus:!0,refreshAfterCallback:!1,popup:!0,callback:function(){this.popups.isVisible("video.insert")?(this.$el.find(".fr-marker")&&(this.events.disableBlur(),this.selection.restore()),this.popups.hide("video.insert")):this.video.showInsertPopup()},plugin:"video"}),e.FE.DefineIcon("insertVideo",{NAME:"video-camera"}),e.FE.DefineIcon("videoByURL",{NAME:"link"}),e.FE.RegisterCommand("videoByURL",{title:"By URL",undo:!1,focus:!1,callback:function(){this.video.showLayer("video-by-url")},refresh:function(e){this.video.refreshByURLButton(e)}}),e.FE.DefineIcon("videoEmbed",{NAME:"code"}),e.FE.RegisterCommand("videoEmbed",{title:"Embedded Code",undo:!1,focus:!1,callback:function(){this.video.showLayer("video-embed")},refresh:function(e){this.video.refreshEmbedButton(e)}}),e.FE.RegisterCommand("videoInsertByURL",{undo:!0,focus:!0,callback:function(){this.video.insertByURL()}}),e.FE.RegisterCommand("videoInsertEmbed",{undo:!0,focus:!0,callback:function(){this.video.insertEmbed()}}),e.FE.DefineIcon("videoDisplay",{NAME:"star"}),e.FE.RegisterCommand("videoDisplay",{title:"Display",type:"dropdown",options:{inline:"Inline",block:"Break Text"},callback:function(e,t){this.video.display(t)},refresh:function(e){this.opts.videoTextNear||e.addClass("fr-hidden")},refreshOnShow:function(e,t){this.video.refreshDisplayOnShow(e,t)}}),e.FE.DefineIcon("videoAlign",{NAME:"align-center"}),e.FE.RegisterCommand("videoAlign",{type:"dropdown",title:"Align",options:{left:"Align Left",justify:"None",right:"Align Right"},html:function(){var t='<ul class="fr-dropdown-list">',i=e.FE.COMMANDS.videoAlign.options;for(var o in i)i.hasOwnProperty(o)&&(t+='<li><a class="fr-command fr-title" data-cmd="videoAlign" data-param1="'+o+'" title="'+this.language.translate(i[o])+'">'+this.icon.create("align-"+o)+"</a></li>");return t+="</ul>"},callback:function(e,t){this.video.align(t)},refresh:function(e){this.video.refreshAlign(e)},refreshOnShow:function(e,t){this.video.refreshAlignOnShow(e,t)}}),e.FE.DefineIcon("videoRemove",{NAME:"trash"}),e.FE.RegisterCommand("videoRemove",{title:"Remove",callback:function(){this.video.remove()}}),e.FE.DefineIcon("videoSize",{NAME:"arrows-alt"}),e.FE.RegisterCommand("videoSize",{undo:!1,focus:!1,title:"Change Size",callback:function(){this.video.showSizePopup()}}),e.FE.DefineIcon("videoBack",{NAME:"arrow-left"}),e.FE.RegisterCommand("videoBack",{title:"Back",undo:!1,focus:!1,back:!0,callback:function(){this.video.back()},refresh:function(e){var t=this.video.get();t||this.opts.toolbarInline?(e.removeClass("fr-hidden"),e.next(".fr-separator").removeClass("fr-hidden")):(e.addClass("fr-hidden"),e.next(".fr-separator").addClass("fr-hidden"))}}),e.FE.RegisterCommand("videoSetSize",{undo:!0,focus:!1,callback:function(){this.video.setSize()}})});